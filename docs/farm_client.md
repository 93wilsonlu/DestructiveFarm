Клиент фермы
============

*Скриншот*

**Клиент фермы** &mdash; это утилита, которая регулярно запускает эксплоит, чтобы атаковать чужие команды, и следит за его работой. Запускается участником на своём ноутбуке после написания эксплоита.

Клиент представляет собой скрипт *start_sploit.py* из данного репозитория. Для запуска требуется Python 3 и ОС Linux, macOS или Windows. Клиент не требует установки каких-либо библиотек.

## Установка и запуск

Так как клиент представляет собой один файл, для его установки в Linux и macOS можно воспользоваться командой:

```bash
wget bit.ly/start_sploit_v2 -O start_sploit.py && chmod +x start_sploit.py
```

В простейшем случае эксплоит может быть запущен следующим образом:

```bash
./client/start_sploit.py sploit.py
```

## Подключение к серверу фермы

Стандартно клиент подключается к серверу фермы по адресу `http://farm.kolambda.com:5000`. В начале каждого соревнования администратор в нашей команде меняет A-запись на этом домене так, чтобы она указывала на IP, соответствующий серверу фермы в локальной сети. Благодаря этому другим участникам команды не нужно заботиться о правильном IP сервера.

*Скриншот с DigitalOcean*

Есть два способа использовать ферму без доступа к указанному домену:

- Каждый раз при запуске клиента указывать опцию `--server-url URL`.

- Изменить [стандартный домен] сервера в файле `start_sploit.py` на домен, A-записи которого может контролировать ваш администратор, и попросить членов команды использовать обновлённый скрипт. Обратите внимание, что соответствующие A-записи должны иметь маленький TTL (иначе ваши изменения будут применяться с задержкой).

## Алгоритм работы

Работа клиента фермы состоит из проведения *атак*. В рамках каждой атаки клиент запрашивает у сервера фермы (если он доступен) настройки (список команд, формат флага), после чего атакует все команды из списка с помощью эксплоита. Одна атака не может длиться больше времени, чем количество секунд, указанных в опции `--attack-period` (стандартно &mdash; 120 секунд). Очевидно, этот период не должен быть больше, чем *время жизни флага* (период после добавления флага в сервис, в течение которого проверяющая система считает его корректным).

Количество процессов с эксплоитом, работающих одновременно, не может превышать значение опции `--pool-size` (стандартно &mdash; 50 процессов). Это ограничение позволяет избежать заполнения всей доступной оперативной памяти (и последующего зависания компьютера) на соревнованиях с большим количеством команд (например, в RuCTFE может участвовать более 400 команд) или в случае ресурсоёмких сплоитов.

В соответствии с описанными параметрами, максимальное время работы (*time limit*) для одного процесса с эксплоитом рассчитывается как `attack_period / ceil(len(teams) / pool_size)` (и выводится в начале каждой атаки). По истечении этого времени клиент фермы убивает процесс.

Во время работы эксплоита клиент следит за его выводом и, как только в выводе появляется подстрока, удовлетворяющая формату флага, добавляет её в очередь на отправку на сервер. Одни и те же флаги не добавляются в очередь дважды. Содержимое очереди отправляется на сервер фермы каждые 5 секунд.

При запуске клиент фермы проверяет часть требований к [формату эксплоита](docs/exploit_format.md).

В редких случаях эксплоит не требуется запускать отдельно для каждой команды. Тогда можно применить опцию клиента `--not-per-team`, при которой каждая атака будет состоять из одного запуска сплоита без аргументов командной строки.

## Что делать, если указанного time limit недостаточно?

1. Увеличьте `--attack-period`. Например, время жизни флага на RuCTF обычно составляет 5 минут, поэтому `--attack-period` можно увеличить более, чем в 2 раза.

    В таком случае небольшая часть флагов может быть потеряна (если сервис противника упал на небольшой период, совпавший с запуском эксплоита, часть флагов этой команды уже умрёт к следующей атаке).

2. Увеличьте `--pool-size`. Это грозит исчерпанием свободной памяти и зависанием компьютера.

3. Используйте опцию `--distribute=K/N`. Тогда список команд будет детерминированным образом поделён на N частей, после чего клиент будет запускать сплоит только на K-й части списка. Таким образом, запуск эксплоита можно будет распределить между N компьютерами.

## Отладка эксплоитов

Первые несколько атак (опция `--verbose-attacks`) клиент фермы будет показывать содержимое stdout и stderr эксплоита для каждой из команд, а также список флагов, извлечённых из этого вывода. Это позволяет увидеть, какие ошибки возникают при запуске эксплоита.

В конце каждой атаки клиент показывает, какой процент процессов с эксплоитом (за всё время работы клиента) превысил отведённый им time limit.

## Дополнительные особенности

- Эксплоиты запускаются с переменной окружения `PYTHONUNBUFFERED=1`, благодаря которой в эксплоитах на Python процедура `flush(stdout)` выполняется автоматически после вывода каждого перевода строки (это позволяет избежать потери флагов, см. [формат эксплоита](docs/exploit_format.md)).
